#!/bin/bash

### Define Resources ###########################################################
################################################################################
#SBATCH --job-name=Indexing
#SBATCH --time=24:00:00 --nodes=1 --ntasks=1 --cpus-per-task=1 --mem=40G
#SBATCH --mail-type=BEGIN,FAIL,END
OUTFILE="slurm-$SLURM_JOB_ID.out"

### Option Variables ###########################################################
################################################################################
[[ -z $SEQUENCE_PREFIX ]] && SEQUENCE_PREFIX=sequences
[[ -z $MAIL_INTERVAL ]]   && MAIL_INTERVAL=1h
################################################################################

is-slurm-job() {
  [[ -n $SLURM_JOB_ID ]]
}

### Repeat $1 times the string $2
repeat() {
  printf '%*.0s' "$1" | sed -e "s| |$2|g"
}

mail-loop() {
  while true; do
    sleep $MAIL_INTERVAL
    echo Mailing update...
    squeue -o '%A %j %u %M %l %L' -j $SLURM_JOB_ID
    sstat -j $SLURM_JOB_ID
    mailme $OUTFILE
  done
}

echo "### Job Info $(repeat $((80-13)) '#')"
repeat 80 '#'; echo
echo "Starting job $SLURM_JOB_ID($SLURM_JOB_NAME)"
printf "Command Line: %s\n" "$0 $*"
echo Environment:
env
repeat 80 '#'; echo

### Modules ####################################################################
################################################################################
module purge

# GNU
module load GNU/6.4.0-2.28 OpenMPI/2.1.1

# Intel C
#module load icc/2017.4.196-GCC-6.4.0-2.28 impi/2017.3.196
# Intel Fortran
#module load ifort/2017.4.196-GCC-6.4.0-2.28 impi/2017.3.196

module load BWA/0.7.17
################################################################################

refgnm="Homo_sapiens.GRCh38.dna.toplevel.fa.gz"
tmp_prefix=$(mktemp --tmpdir -d ${USER}_slurm-${SLURM_JOB_ID}.XXX)
mkdir "$tmp_prefix/output"
cp "$SEQUENCE_PREFIX/$refgnm" "$tmp_prefix/$refgnm"

index_cmd=(bwa index -a bwtsw -p "$tmp_prefix/output" "$tmp_prefix/$refgnm")

echo Running indexing job...
if is-slurm-job; then
  mail-loop &
  mail_loop_pid=$!

  time srun -N 1 "${index_cmd[@]}"
else
  "${index_cmd[@]}" &

  echo Waiting for process to terminate...
  while kill %%; do
    sleep 1
  done
fi

cp -R "$tmp_prefix"/output/* "$SEQUENCE_PREFIX"
rm -rf "$tmp_prefix"

is-slurm-job && kill $mail_loop_pid

echo
echo "### Job Info $(repeat $((80-13)) '#')"
repeat 80 '#'; echo
printf "Command Line: %s\n" "$0 $*"
if is-slurm-job; then
  sacct --format='Elapsed,MaxRSS' -j $SLURM_JOB_ID
  scontrol show job $SLURM_JOB_ID
fi
